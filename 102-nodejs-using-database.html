<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="">
  <!--<![endif]-->
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=UA-146447294-1"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "UA-146447294-1");
    </script>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Cristopher André</title>
    <meta
      name="description"
      content="Martin is a responsive creative template"
    />
    <meta
      name="keywords"
      content="portfolio, personal, corporate, business, parallax, creative, agency"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="./dist/img/favicon.ico" rel="icon" type="image/png" />

    <!-- bootstrap css -->
    <link rel="stylesheet" href="./dist/css/bootstrap.min.css" />

    <!-- google fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Muli:200,300,400,600,700,,800,900|Josefin+Sans:300,400,600,700"
      rel="stylesheet"
    />

    <!-- owl carousel CSS 
		<link rel="stylesheet" href="./dist/css/owl.carousel.min.css">
		<link rel="stylesheet" href="./dist/css/owl.theme.default.min.css">
		-->

    <!-- magnific-popup CSS 
		<link rel="stylesheet" href="./dist/css/magnific-popup.css">
		-->

    <!-- Font Icon Core CSS -->
    <link rel="stylesheet" href="./dist/css/font-awesome.min.css" />
    <!--
		<link rel="stylesheet" href="./dist/css/et-line.css">
		<link rel="stylesheet" href="./dist/css/ionicons.min.css">
		-->

    <!-- Core Style Css -->
    <link rel="stylesheet" href="./dist/css/style.css" />

    <!--[if lt IE 9]-->
    <script src="./dist/js/html5shiv.min.js"></script>
    <!--[endif]-->

    <!-- SyntaxHighlighter -->
    <!--
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shThemeDefault.min.css">
		-->

    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shCore.min.css">-->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shCoreEclipse.min.css"
    />
  </head>
  <body>
    <!-- ====== Preloader ======  -->
    <div class="loading">
      <div class="load-circle"></div>
    </div>
    <!-- ======End Preloader ======  -->

    <!-- ====== button-top ======  -->
    <div class="button-top" data-scroll-nav="0">
      <span>
        <i class="fa fa-angle-up" aria-hidden="true"></i>
      </span>
    </div>
    <!-- ======End button-top ======  -->

    <!-- ====== Navgition ======  -->
    <nav class="navbar navbar-default">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button
            type="button"
            class="navbar-toggle collapsed"
            data-toggle="collapse"
            data-target="#nav-icon-collapse"
            aria-expanded="false"
          >
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>

          <!-- logo -->
          <a href="https://cristopherandre.com">
            <div class="logo">
              <img src="./dist/img/logo.png" alt="logo" />
            </div>
          </a>
        </div>

        <!-- Collect the nav links, and other content for toggling -->
        <div class="collapse navbar-collapse" id="nav-icon-collapse">
          <!-- links -->
          <ul class="nav navbar-nav navbar-right">
            <li><a href="index.html#home" class="active">Home</a></li>
            <li><a href="index.html#about">About</a></li>
            <li><a href="index.html#resume">Resume</a></li>
            <li><a href="index.html#knowledge">Knowledge</a></li>
            <li><a href="index.html#blog">Blog</a></li>
            <li><a href="index.html#contact">Contact</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
      <!-- /.container -->
    </nav>
    <!-- ====== End Navgition ======  -->

    <!--====== Header ======-->
    <section class="sub-header">
      <div class="container">
        <div class="v-middle">
          <!-- Caption -->
          <div class="caption text-center">
            <h1 class="mb-15">Node.js Using Database</h1>
            <!--<h6>Single Post</h6>-->
          </div>
        </div>
      </div>
    </section>
    <!--====== End Header ======-->

    <!--====== mp-blog ======-->
    <section class="mp-blog section-padding">
      <div class="container">
        <div class="row">
          <!-- posts -->
          <div class="col-md-12">
            <div class="posts">
              <!-- item -->
              <div class="item">
                <div class="content">
                  <!--
									<div class="post-img">
										<a href="#0">
											<img src="./dist/img/blog/1.jpg" alt="image">
										</a>
									</div>
									-->

                  <div class="post-info">
                    <a href="#0">
                      <h5>Node.js Using Database</h5>
                    </a>
                    <div class="mor-inf">
                      <ul>
                        <li>
                          <span class="icon">
                            <i class="fa fa-user" aria-hidden="true"></i>
                          </span>
                          <span>Posted By Cristopher André</span>
                        </li>
                        <li style="color: #7159c1; font-size: 12px;">
                          <span class="icon">
                            <i class="fa fa-github" aria-hidden="true"></i>
                          </span>
                          <span>
                            <b>
                              <a
                                href="https://github.com/cristopherAndre/nodejs-using-database"
                                target="_blank"
                                >Github Project</a
                              >
                            </b>
                          </span>
                        </li>
                        <li>
                          <span class="icon">
                            <i class="fa fa-tags" aria-hidden="true"></i>
                          </span>
                          <span>Node.js - Express - Nodemon</span>
                        </li>
                      </ul>
                    </div>
                    <p class="mb-10">
                      Let's install the Sequelize, it's a promise-based Node.js
                      ORM for Postgres, MySQL, MariaDB, SQLite and Microsoft SQL
                      Server.
                    </p>

                    <p class="spacial">
                      $ yarn add sequelize
                      <br />
                      $ yarn add sequelize-cli -D
                    </p>
                    <p class="mb-10">
                      Let's create the ".sequelizerc" file, it's a special
                      configuration file. It lets you specify various options
                      that you would usually pass as arguments to CLI, so let's
                      set some configs.
                    </p>

                    <p>.sequelizerc</p>
                    <pre class="brush: javascript">
                        const { resolve } = require('path');

                        module.exports = {
                          config: resolve(__dirname, 'src', 'config', 'database.js'),
                          'models-path': resolve(__dirname, 'src', 'app', 'models'),
                          'migrations-path': resolve(__dirname, 'src', 'database', 'migrations'),
                          'seeders-path': resolve(__dirname, 'src', 'database', 'seeds'),
                        }
                    </pre>

                    <p class="mb-10">
                      We are going to use the postgres, so we need to install
                      the driver to this database.
                    </p>
                    <p class="spacial">
                      $ yarn add pg pg-hstore
                    </p>

                    <p class="mb-10">
                      Now we need to configure or database connections, to do
                      this we will use the "database.js" file.
                    </p>
                    <p>database.js</p>
                    <pre class="brush: javascript">
                      module.exports = {
                        dialect: 'postgres',
                        host: 'localhost',
                        username: 'postgres',
                        password: 'docker',
                        database: 'meetapp',
                        define: {
                          timestamps: true,
                          underscored: true,
                          underscoredAll: true,
                        },
                      };
                    </pre>

                    <br />
                    <hr />
                    <br />

                    <h5>Migrations</h5>
                    <p class="mb-10">
                      Just like you use Git / SVN to manage changes in your
                      source code, you can use migrations to keep track of
                      changes to the database. With migrations you can transfer
                      your existing database into another state and vice versa:
                      Those state transitions are saved in migration files,
                      which describe how to get to the new state and how to
                      revert the changes in order to get back to the old state.
                      Let's create our first migration using the Sequelize CLI.
                    </p>

                    <p class="spacial">
                      $ yarn sequelize db:create
                      <br/>
                      $ yarn sequelize migration:create --name=create-users
                    </p>

                    <p>migration file</p>
                    <pre class="brush: javascript">
                      module.exports = {
                        up: (queryInterface, Sequelize) => {
                          return queryInterface.createTable('users', { id: Sequelize.INTEGER });
                        },
                      
                        down: (queryInterface, Sequelize) => {
                          return queryInterface.dropTable('users');
                        },
                      };
                    </pre>
                    <p class="mb-10">
                      Let's create a users migration:
                    </p>
                    <p>migration file</p>
                    <pre class="brush: javascript">
                        module.exports = {
                          up: (queryInterface, Sequelize) => {
                            return queryInterface.createTable('users', {
                              id: {
                                type: Sequelize.INTEGER,
                                allowNull: false,
                                autoIncrement: true,
                                primaryKey: true,
                              },
                              name: {
                                type: Sequelize.STRING,
                                allowNull: false,
                              },
                              email: {
                                type: Sequelize.STRING,
                                allowNull: false,
                                unique: true,
                              },
                              password_hash: {
                                type: Sequelize.STRING,
                                allowNull: false,
                              },
                              created_at: {
                                type: Sequelize.DATE,
                                allowNull: false,
                              },
                              updated_at: {
                                type: Sequelize.DATE,
                                allowNull: false,
                              },
                            });
                          },
                        
                          down: queryInterface => {
                            return queryInterface.dropTable('users');
                          },
                        };                        
                    </pre>
                    <p class="mb-10">
                      To run this migration we will execute the command bellow:
                    </p>
                    <p class="spacial">
                      $ yarn sequelize db:migrate
                    </p>
                    <p class="mb-10">
                      We also can run a rollback with these commands:
                    </p>
                    <p class="spacial">
                      $ yarn sequelize db:migrate:undo
                      <br />
                      $ yarn sequelize db:migrate:undo:all
                    </p>



                    <br />
                    <hr />
                    <br />

                    <h5>Seeders</h5>
                    <p class="mb-10">
                      Suppose we want to insert some data into a few tables by default.

                      To manage all data migrations you can use seeders. Seed files are some change in data that can be used to populate database table with sample data or test data.
                      Let's create a seed file which will add an admin user to our User table.
                    </p>

                    <p class="spacial">
                      $ yarn sequelize seed:generate --name admin-user
                    </p>

                    <p>seed file</p>
                    <pre class="brush: javascript">
                      const bcrypt = require('bcryptjs');
                      module.exports = {
                          up: QueryInterface => {
                              return QueryInterface.bulkInsert(
                                  'users',
                                  [
                                      {
                                          name: 'Distribuidora FastFeet',
                                          email: 'admin@fastfeet.com',
                                          admin: true,
                                          password_hash: bcrypt.hashSync('123456', 8),
                                          created_at: new Date(),
                                          updated_at: new Date(),
                                      },
                                  ],
                                  {}
                              );
                          },
                          down: () => {},
                      };
                    </pre>
                    <p class="mb-10">
                      In last step you have create a seed file. It's still not committed to database. To do that we need to run a simple command.
                    </p>
                    
                    <p class="spacial">
                      $ yarn sequelize db:seed:all
                    </p>
                    <p class="mb-10">
                      We also can run a rollback with these commands:
                    </p>
                    <p class="spacial">
                      $ yarn sequelize db:seed:undo
                      <br />
                      $ yarn sequelize db:seed:undo:all
                      <br />
                      $ yarn sequelize db:seed:undo --seed name-of-seed-as-in-data
                    </p>

                    <br />
                    <hr />
                    <br />

                    <h5>Model</h5>
                    <p class="mb-10">
                      Let's create a User model.
                    </p>

                    <p>User.js</p>
                    <pre class="brush: javascript">
                      import Sequelize, { Model } from 'sequelize';

                      class User extends Model {
                        static init(sequelize) {
                          super.init(
                            {
                              name: Sequelize.STRING,
                              email: Sequelize.STRING,
                              password_hash: Sequelize.STRING,
                            },
                            {
                              sequelize,
                            }
                          );
                        }
                      }

                      export default User;
                    </pre>
                    <p class="mb-10">
                      Let's go config the database connection and load the
                      models.
                    </p>
                    <p>database/index.js</p>
                    <pre class="brush: javascript">
                        import Sequelize from 'sequelize';
                        import databaseConfig from '../config/database';
                        import User from '../app/models/User';
                        
                        const models = [User];
                        
                        class Database {
                          constructor() {
                            this.init();
                          }
                        
                          init() {
                            this.connection = new Sequelize(databaseConfig);
                            models.map(model => model.init(this.connection));
                          }
                        }
                        
                        export default new Database();                        
                    </pre>
                    <p class="mb-10">
                      So, now we need to call this file, we can do this in the
                      app.js file.
                    </p>
                    <p>app.js</p>
                    <pre class="brush: javascript">
                        import express from 'express';
                        import routes from './routes';
                        import './database'; // <---- Here <----
                        
                        class App {
                          constructor() {
                            this.server = express();
                            this.middlewares();
                            this.routes();
                          }
                        
                          middlewares() {
                            this.server.use(express.json());
                          }
                        
                          routes() {
                            this.server.use(routes);
                          }
                        }
                        
                        export default new App().server;                        
                    </pre>

                    <br />
                    <hr />
                    <br />

                    <h5>Controller</h5>
                    <p class="mb-10">
                      Let's create a User Controller.
                    </p>

                    <p>UserController.js</p>
                    <pre class="brush: javascript">
                        import User from '../models/User';

                        class UserController {
                          async store(req, res) {
                            const userExists = await User.findOne({ where: { email: req.body.email } });
                            if (userExists) {
                              return res.status(400).json({ error: 'User alredy exists' });
                            }
                            const user = await User.create(req.body);
                            return res.json(user);
                          }
                        }
                        
                        export default new UserController();                                               
                    </pre>

                    <p class="mb-10">
                      Now let's change the routes.js file to use our new
                      controller to create an user.
                    </p>
                    <p>routes.js</p>
                    <pre class="brush: javascript">
                        import { Router } from 'express';
                        import UserController from './app/controllers/UserController';
                        
                        const routes = new Router();
                        
                        routes.post('/users', UserController.store);
                        
                        export default routes;
                    </pre>

                    <br />
                    <hr />
                    <br />

                    <h5>Sequelize Hooks & bcryptjs</h5>
                    <p class="mb-10">
                      Hooks (also known as lifecycle events), are functions
                      which are called before and after calls in sequelize are
                      executed. For example, if you want to always set a value
                      on a model before saving it, you can add a beforeUpdate
                      hook.
                      <br />
                      Bcrypt is a password hashing function designed by Niels
                      Provos and David Maxieres, based on Blowfish encryption.
                    </p>
                    <p class="mb-10">
                      Let's create a hook to encrypt our password before save it
                      into our database.
                    </p>
                    <p>User.js</p>
                    <pre class="brush: javascript">
                        import Sequelize, { Model } from 'sequelize';
                        import bcrypt from 'bcryptjs';
                        
                        class User extends Model {
                          static init(sequelize) {
                            super.init(
                              {
                                name: Sequelize.STRING,
                                email: Sequelize.STRING,
                                password: Sequelize.VIRTUAL,
                                password_hash: Sequelize.STRING,
                              },
                              {
                                sequelize,
                              }
                            );
                        
                            this.addHook('beforeSave', async user => {
                              if (user.password) {
                                user.password_hash = await bcrypt.hash(user.password, 8);
                              }
                            });
                        
                            return this;
                          }
                        }
                        
                        export default User;                        
                    </pre>
                    <br />
                    <hr />
                    <br />

                    <h5>JWT - JSON Web Token</h5>
                    <p class="mb-10">
                      JSON Web Token (JWT) is a compact URL-safe means of
                      representing claims to be transferred between two parties.
                      <br />
                      Let's install the lib jsonwebtoken.
                    </p>

                    <p class="spacial">
                      $ yarn add jsonwebtoken
                    </p>
                    <p class="mb-10">
                      Let's create a jwt config file:
                    </p>
                    <p>config/auth.js</p>
                    <pre class="brush: javascript">
                        export default {
                          secret: 'b6d8a00f8f0c03930b8b7b4175a5f9f9',
                          expiresIn: '7d',
                        };                        
                    </pre>
                    <p class="mb-10">
                      And now we need to create a Session Controller.
                    </p>
                    <p>SessionController.js</p>
                    <pre class="brush: javascript">
                        import jwt from 'jsonwebtoken';
                        import User from '../models/User';
                        import authConfig from '../../config/auth';
                        
                        class SessionController {
                          async store(req, res) {
                            const { email, password } = req.body;
                            const user = await User.findOne({ where: { email } });
                            if (!user) {
                              return res.status(401).json({ error: 'User not found.' });
                            }
                            if (!(await user.checkPassword(password))) {
                              return res.status(401).json({ error: 'Password does not match.' });
                            }
                            const { id, name } = user;
                            return res.json({
                              user: {
                                id,
                                name,
                                email,
                              },
                              token: jwt.sign({ id }, authConfig.secret, {
                                expiresIn: authConfig.expiresIn,
                              }),
                            });
                          }
                        }
                        
                        export default new SessionController();                        
                    </pre>
                    <p class="mb-10">
                      We also need to create a new route
                    </p>
                    <p>routes.js</p>
                    <pre class="brush: javascript">
                        import { Router } from 'express';
                        import UserController from './app/controllers/UserController';
                        import SessionController from './app/controllers/SessionController';
                        
                        const routes = new Router();
                        
                        routes.post('/users', UserController.store);
                        routes.post('/sessions', SessionController.store);
                        
                        export default routes;                        
                    </pre>
                    <br />
                    <hr />
                    <br />

                    <h5>Authentication Middleware</h5>
                    <p class="mb-10">
                      Middleware functions are functions that have access to the
                      request object (req), the response object (res), and the
                      next middleware function in the application’s
                      request-response cycle. The next middleware function is
                      commonly denoted by a variable named next. Middleware
                      functions can perform the following tasks:
                    </p>
                    <p class="spacial">
                      -> Execute any code.
                      <br />
                      -> Make changes to the request and the response objects.
                      <br />
                      -> End the request-response cycle.
                      <br />
                      -> Call the next middleware function in the stack.
                    </p>
                    <p class="mb-10">
                      Let's create our authorization middleware.
                    </p>

                    <p>middlewares/auth.js</p>
                    <pre class="brush: javascript">
                        import jwt from 'jsonwebtoken';
                        import { promisify } from 'util';
                        import authConfig from '../../config/auth';
                        
                        export default async (req, res, next) => {
                          const authHeader = req.headers.authorization;
                          if (!authHeader) {
                            return res.status(401).json({ error: 'Token not provided' });
                          }
                          const [, token] = authHeader.split(' ');
                        
                          try {
                            const decoded = await promisify(jwt.verify)(token, authConfig.secret);
                            req.userId = decoded.id;
                            return next();
                          } catch (err) {
                            return res.status(401).json({ error: 'Token invalid.' });
                          }
                        };                        
                    </pre>

                    <p class="mb-10">
                      And let's set this middleware to the update route, so when
                      someone try to update a user this middleware will be
                      called and it will verify if the requester is
                      authenticated.
                    </p>
                    <p>routes.js</p>
                    <pre class="brush: javascript">
                        import { Router } from 'express';
                        import UserController from './app/controllers/UserController';
                        import SessionController from './app/controllers/SessionController';
                        import authMiddleware from './app/middlewares/auth';
                        
                        const routes = new Router();
                        
                        routes.post('/users', UserController.store);
                        routes.put('/users', authMiddleware, UserController.update); // <----- HERE <-----
                        
                        routes.post('/sessions', SessionController.store);
                        
                        export default routes;
                        
                    </pre>
                    <br />
                    <hr />
                    <br />

                    <h5>Yup</h5>
                    <p class="mb-10">
                      Yup is a JavaScript object schema validator and object
                      parser, let's install the yup.
                    </p>
                    <p class="spacial">
                      $ yarn add yup
                    </p>
                    <p class="mb-10">
                      With the yup we can create a scheme to execute the
                      validation.
                    </p>
                    <pre class="brush: javascript">
                        const schema = Yup.object().shape({
                          name: Yup.string().required(),
                          email: Yup.string()
                            .email()
                            .required(),
                          password: Yup.string()
                            .required()
                            .min(6),
                        });
                        if (!(await schema.isValid(req.body))) {
                          return res.status(400).json({ error: 'Validation fails' });
                        }
                    </pre>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!--====== End mp-blog ======-->

    <!-- ====== Footer ======  -->
    <footer class="gray">
      <p class="copy">
        Copy Right &copy; By Cristopher André | ALL RIGHTS RESERVED
      </p>
    </footer>
    <!-- ====== End Footer ======  -->

    <!-- jQuery -->
    <script src="./dist/js/jquery-3.0.0.min.js"></script>
    <script src="./dist/js/jquery-migrate-3.0.0.min.js"></script>

    <!-- bootstrap -->
    <script src="./dist/js/bootstrap.min.js"></script>

    <!-- isotope.pkgd.min js -->
    <script src="./dist/js/isotope.pkgd.min.js"></script>

    <!-- validator js -->
    <script src="./dist/js/validator.js"></script>

    <!-- custom script -->
    <script src="./dist/js/custom.js"></script>

    <!-- SyntaxHighlighter script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shCore.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushJava.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushJScript.min.js"></script>

    <script type="text/javascript">
      SyntaxHighlighter.all();
    </script>
  </body>
</html>
